<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BeePlan Course Scheduler</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        html, body {
            height: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0 0 10px 0;
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
        }

        .header p {
            margin: 0;
            color: #4a5568;
            font-size: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100% - 140px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .schedule-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: auto;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .course-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }

        .course-item {
            background: #f7fafc;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }

        .course-item.lab {
            border-left-color: #ed8936;
        }

        .course-item strong {
            color: #2d3748;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .timetable th, .timetable td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
            vertical-align: top;
        }

        .timetable th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .time-slot {
            background: #f7fafc;
            font-weight: 500;
            color: #4a5568;
            width: 80px;
        }

        .course-slot {
            background: #667eea;
            color: white;
            font-size: 11px;
            padding: 4px;
            border-radius: 4px;
            margin: 1px;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .course-slot.lab {
            background: #ed8936;
        }

        .course-slot.conflict {
            background: #e53e3e;
            animation: pulse 1s infinite;
        }

        .exam-block {
            background: #fed7d7 !important;
            color: #c53030;
            font-weight: 600;
        }

        .status-bar {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #48bb78;
        }

        .status-bar.error {
            border-left-color: #e53e3e;
            background: #fed7d7;
        }

        .status-bar.warning {
            border-left-color: #ed8936;
            background: #feebc8;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .year-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .year-tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .year-tab.active {
            background: #667eea;
            color: white;
        }

        .validation-report {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .validation-item {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .validation-item.error {
            background: #fed7d7;
            color: #c53030;
        }

        .validation-item.warning {
            background: #feebc8;
            color: #c05621;
        }

        .validation-item.success {
            background: #c6f6d5;
            color: #276749;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <header class="header">
    <h1 id="app-title">BeePlan Course Scheduler</h1>
    <p id="department-name">Computer Engineering Department - Automated Course Scheduling System</p>
   </header>
   <div class="main-content">
    <aside class="sidebar">
     <div class="section">
      <h3>Add Course</h3>
      <form id="course-form">
       <div class="form-group"><label for="course-name">Course Name</label> <input type="text" id="course-name" placeholder="e.g., Data Structures" required>
       </div>
       <div class="form-group"><label for="instructor">Instructor</label> <input type="text" id="instructor" placeholder="e.g., Dr. Smith" required>
       </div>
       <div class="form-group"><label for="hours">Hours per Week</label> <input type="number" id="hours" min="1" max="8" value="3" required>
       </div>
       <div class="form-group"><label for="year">Year</label> <select id="year" required> <option value="1">1st Year</option> <option value="2">2nd Year</option> <option value="3">3rd Year</option> <option value="4">4th Year</option> </select>
       </div>
       <div class="checkbox-group"><input type="checkbox" id="is-lab"> <label for="is-lab">Laboratory Course</label>
       </div>
       <div class="form-group"><label for="capacity">Class Capacity</label> <input type="number" id="capacity" min="1" max="200" value="30">
       </div><button type="submit" class="btn btn-primary" id="add-course-btn"> Add Course </button>
      </form>
     </div>
     <div class="section">
      <h3>Actions</h3><button class="btn btn-success" id="generate-schedule-btn"> Generate Schedule </button> <button class="btn btn-secondary" id="view-report-btn"> View Validation Report </button> <button class="btn btn-secondary" id="clear-all-btn"> Clear All Courses </button>
     </div>
     <div class="section">
      <h3>Course List</h3>
      <div class="course-list" id="course-list">
       <p style="color: #718096; text-align: center; margin: 20px 0;">No courses added yet</p>
      </div>
     </div>
    </aside>
    <main class="schedule-area">
     <div id="status-bar" class="status-bar" style="display: none;"><span id="status-message"></span>
     </div>
     <div class="year-tabs"><button class="year-tab active" data-year="1">1st Year</button> <button class="year-tab" data-year="2">2nd Year</button> <button class="year-tab" data-year="3">3rd Year</button> <button class="year-tab" data-year="4">4th Year</button>
     </div>
     <div id="schedule-container">
      <table class="timetable" id="timetable">
       <thead>
        <tr>
         <th>Time</th>
         <th>Monday</th>
         <th>Tuesday</th>
         <th>Wednesday</th>
         <th>Thursday</th>
         <th>Friday</th>
        </tr>
       </thead>
       <tbody id="timetable-body"><!-- Time slots will be generated here -->
       </tbody>
      </table>
     </div>
     <div id="validation-report" class="validation-report" style="display: none;">
      <h3>Validation Report</h3>
      <div id="validation-content"></div>
     </div>
    </main>
   </div>
  </div>
  <script>
        // Configuration and state
        const defaultConfig = {
            app_title: "BeePlan Course Scheduler",
            department_name: "Computer Engineering Department - Automated Course Scheduling System",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            surface_color: "#ffffff",
            text_color: "#2d3748",
            accent_color: "#48bb78"
        };

        let courses = [];
        let schedule = {};
        let currentYear = 1;
        let isGenerating = false;

        // Time slots (8:00 AM to 6:00 PM)
        const timeSlots = [
            "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00",
            "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00",
            "16:00-17:00", "17:00-18:00"
        ];

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

        // Data SDK handler
        const dataHandler = {
            onDataChanged(data) {
                courses = data.filter(item => item.type === 'course');
                updateCourseList();
                if (Object.keys(schedule).length > 0) {
                    displaySchedule();
                }
            }
        };

        // Element SDK configuration
        async function onConfigChange(config) {
            const appTitle = config.app_title || defaultConfig.app_title;
            const departmentName = config.department_name || defaultConfig.department_name;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            const textColor = config.text_color || defaultConfig.text_color;

            document.getElementById('app-title').textContent = appTitle;
            document.getElementById('department-name').textContent = departmentName;

            // Update CSS custom properties for dynamic theming
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--surface-color', surfaceColor);
            document.documentElement.style.setProperty('--text-color', textColor);

            // Update button and UI element colors
            const buttons = document.querySelectorAll('.btn-primary');
            buttons.forEach(btn => {
                btn.style.backgroundColor = primaryColor;
            });

            const courseSlots = document.querySelectorAll('.course-slot:not(.lab):not(.conflict)');
            courseSlots.forEach(slot => {
                slot.style.backgroundColor = primaryColor;
            });
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.surface_color || defaultConfig.surface_color,
                        set: (value) => {
                            config.surface_color = value;
                            window.elementSdk.setConfig({ surface_color: value });
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["department_name", config.department_name || defaultConfig.department_name]
            ]);
        }

        // Initialize application
        async function initializeApp() {
            try {
                // Initialize Element SDK
                if (window.elementSdk) {
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange,
                        mapToCapabilities,
                        mapToEditPanelValues
                    });
                }

                // Initialize Data SDK
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        showStatus('Failed to initialize data storage', 'error');
                        return;
                    }
                }

                initializeUI();
                showStatus('BeePlan initialized successfully', 'success');
            } catch (error) {
                showStatus('Failed to initialize application', 'error');
            }
        }

        function initializeUI() {
            generateTimetableGrid();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Course form submission
            document.getElementById('course-form').addEventListener('submit', handleAddCourse);

            // Action buttons
            document.getElementById('generate-schedule-btn').addEventListener('click', generateSchedule);
            document.getElementById('view-report-btn').addEventListener('click', showValidationReport);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllCourses);

            // Year tabs
            document.querySelectorAll('.year-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    currentYear = parseInt(e.target.dataset.year);
                    updateYearTabs();
                    displaySchedule();
                });
            });
        }

        async function handleAddCourse(e) {
            e.preventDefault();
            
            if (courses.length >= 999) {
                showStatus('Maximum limit of 999 courses reached. Please delete some courses first.', 'error');
                return;
            }

            const btn = document.getElementById('add-course-btn');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span>Adding...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const courseData = {
                    id: `course_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: 'course',
                    name: document.getElementById('course-name').value,
                    instructor: document.getElementById('instructor').value,
                    hours: parseInt(document.getElementById('hours').value),
                    year: parseInt(document.getElementById('year').value),
                    is_lab: document.getElementById('is-lab').checked,
                    capacity: parseInt(document.getElementById('capacity').value),
                    room_type: document.getElementById('is-lab').checked ? 'lab' : 'classroom',
                    created_at: new Date().toISOString()
                };

                if (window.dataSdk) {
                    const result = await window.dataSdk.create(courseData);
                    if (result.isOk) {
                        e.target.reset();
                        showStatus(`Course "${courseData.name}" added successfully`, 'success');
                    } else {
                        showStatus('Failed to add course', 'error');
                    }
                }
            } catch (error) {
                showStatus('Error adding course', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function updateCourseList() {
            const courseList = document.getElementById('course-list');
            
            if (courses.length === 0) {
                courseList.innerHTML = '<p style="color: #718096; text-align: center; margin: 20px 0;">No courses added yet</p>';
                return;
            }

            courseList.innerHTML = courses.map(course => `
                <div class="course-item ${course.is_lab ? 'lab' : ''}">
                    <strong>${course.name}</strong><br>
                    <small>${course.instructor} ‚Ä¢ ${course.hours}h ‚Ä¢ Year ${course.year} ‚Ä¢ ${course.capacity} students</small>
                    ${course.is_lab ? '<br><small>üß™ Laboratory Course</small>' : ''}
                </div>
            `).join('');
        }

        function generateTimetableGrid() {
            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = timeSlots.map(time => `
                <tr>
                    <td class="time-slot">${time}</td>
                    ${days.map(day => `<td id="slot-${day}-${time}" class="schedule-cell"></td>`).join('')}
                </tr>
            `).join('');

            // Mark Friday exam block (13:00-15:00)
            const examSlots = ['13:00-14:00', '14:00-15:00'];
            examSlots.forEach(time => {
                const cell = document.getElementById(`slot-Friday-${time}`);
                if (cell) {
                    cell.className = 'schedule-cell exam-block';
                    cell.innerHTML = '<div style="padding: 10px; font-weight: 600;">EXAM BLOCK</div>';
                }
            });
        }

        async function generateSchedule() {
            if (courses.length === 0) {
                showStatus('Please add some courses first', 'warning');
                return;
            }

            const btn = document.getElementById('generate-schedule-btn');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span>Generating...';
            btn.disabled = true;
            isGenerating = true;

            try {
                showStatus('Generating conflict-free schedule...', 'info');
                
                // Simulate processing time for complex scheduling algorithm
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                schedule = await runSchedulingAlgorithm();
                displaySchedule();
                
                const conflicts = validateSchedule();
                if (conflicts.length === 0) {
                    showStatus('Schedule generated successfully with no conflicts!', 'success');
                } else {
                    showStatus(`Schedule generated with ${conflicts.length} conflicts. Check validation report.`, 'warning');
                }
            } catch (error) {
                showStatus('Failed to generate schedule', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                isGenerating = false;
            }
        }

        async function runSchedulingAlgorithm() {
            const newSchedule = {};
            const instructorSchedule = {};
            const roomSchedule = {};
            
            // Initialize schedule structure
            for (let year = 1; year <= 4; year++) {
                newSchedule[year] = {};
                days.forEach(day => {
                    newSchedule[year][day] = {};
                    timeSlots.forEach(time => {
                        newSchedule[year][day][time] = null;
                    });
                });
            }

            // Sort courses by priority (labs after theory, higher years first)
            const sortedCourses = [...courses].sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                if (a.is_lab !== b.is_lab) return a.is_lab ? 1 : -1;
                return a.hours - b.hours;
            });

            // Schedule each course using backtracking
            for (const course of sortedCourses) {
                let scheduled = false;
                let attempts = 0;
                const maxAttempts = 50;

                while (!scheduled && attempts < maxAttempts) {
                    const placement = findBestTimeSlot(course, newSchedule, instructorSchedule, roomSchedule);
                    if (placement) {
                        // Place the course
                        for (let i = 0; i < course.hours; i++) {
                            const slotIndex = (placement.timeIndex + i) % timeSlots.length;
                            const currentDay = placement.day;
                            const currentTime = timeSlots[slotIndex];
                            
                            newSchedule[course.year][currentDay][currentTime] = {
                                ...course,
                                slotIndex: i
                            };

                            // Track instructor and room usage
                            const key = `${currentDay}-${currentTime}`;
                            if (!instructorSchedule[course.instructor]) {
                                instructorSchedule[course.instructor] = {};
                            }
                            instructorSchedule[course.instructor][key] = course;

                            if (!roomSchedule[course.room_type]) {
                                roomSchedule[course.room_type] = {};
                            }
                            roomSchedule[course.room_type][key] = course;
                        }
                        scheduled = true;
                    }
                    attempts++;
                }

                if (!scheduled) {
                    console.warn(`Could not schedule course: ${course.name}`);
                }
            }

            return newSchedule;
        }

        function findBestTimeSlot(course, schedule, instructorSchedule, roomSchedule) {
            const availableSlots = [];

            for (const day of days) {
                // Skip Friday 13:00-15:00 (exam block)
                const skipSlots = day === 'Friday' ? ['13:00-14:00', '14:00-15:00'] : [];
                
                for (let timeIndex = 0; timeIndex < timeSlots.length - course.hours + 1; timeIndex++) {
                    const time = timeSlots[timeIndex];
                    
                    if (skipSlots.includes(time)) continue;

                    // Check if all required consecutive slots are available
                    let canPlace = true;
                    for (let i = 0; i < course.hours; i++) {
                        const checkTime = timeSlots[timeIndex + i];
                        if (!checkTime || skipSlots.includes(checkTime)) {
                            canPlace = false;
                            break;
                        }

                        // Check year schedule conflict
                        if (schedule[course.year][day][checkTime]) {
                            canPlace = false;
                            break;
                        }

                        // Check instructor availability (max 4 hours theory per day)
                        const instructorKey = `${day}-${checkTime}`;
                        if (instructorSchedule[course.instructor] && instructorSchedule[course.instructor][instructorKey]) {
                            canPlace = false;
                            break;
                        }

                        // Check daily instructor hour limit
                        const dailyHours = getDailyInstructorHours(course.instructor, day, instructorSchedule);
                        if (!course.is_lab && dailyHours >= 4) {
                            canPlace = false;
                            break;
                        }
                    }

                    if (canPlace) {
                        availableSlots.push({
                            day,
                            timeIndex,
                            time,
                            score: calculateSlotScore(course, day, timeIndex)
                        });
                    }
                }
            }

            // Return best slot (highest score)
            return availableSlots.sort((a, b) => b.score - a.score)[0];
        }

        function getDailyInstructorHours(instructor, day, instructorSchedule) {
            let hours = 0;
            timeSlots.forEach(time => {
                const key = `${day}-${time}`;
                if (instructorSchedule[instructor] && instructorSchedule[instructor][key]) {
                    hours++;
                }
            });
            return hours;
        }

        function calculateSlotScore(course, day, timeIndex) {
            let score = 100;

            // Prefer morning slots
            if (timeIndex < 4) score += 20;
            
            // Prefer consecutive lab hours
            if (course.is_lab && course.hours >= 2) {
                score += 15;
            }

            // Avoid late Friday slots
            if (day === 'Friday' && timeIndex > 6) {
                score -= 30;
            }

            // Prefer Monday-Wednesday for core courses
            if (['Monday', 'Tuesday', 'Wednesday'].includes(day)) {
                score += 10;
            }

            return score;
        }

        function displaySchedule() {
            if (!schedule[currentYear]) return;

            // Clear existing schedule display
            document.querySelectorAll('.schedule-cell:not(.exam-block)').forEach(cell => {
                cell.innerHTML = '';
                cell.className = 'schedule-cell';
            });

            // Display courses for current year
            const yearSchedule = schedule[currentYear];
            days.forEach(day => {
                timeSlots.forEach(time => {
                    const course = yearSchedule[day][time];
                    if (course) {
                        const cell = document.getElementById(`slot-${day}-${time}`);
                        if (cell && !cell.classList.contains('exam-block')) {
                            cell.innerHTML = `
                                <div class="course-slot ${course.is_lab ? 'lab' : ''}">
                                    <strong>${course.name}</strong><br>
                                    <small>${course.instructor}</small>
                                </div>
                            `;
                        }
                    }
                });
            });

            // Highlight conflicts
            highlightConflicts();
        }

        function highlightConflicts() {
            const conflicts = validateSchedule();
            
            // Remove existing conflict highlighting
            document.querySelectorAll('.course-slot.conflict').forEach(slot => {
                slot.classList.remove('conflict');
            });

            // Add conflict highlighting
            conflicts.forEach(conflict => {
                if (conflict.type === 'instructor_overlap' || conflict.type === 'room_overlap') {
                    const cells = document.querySelectorAll(`#slot-${conflict.day}-${conflict.time} .course-slot`);
                    cells.forEach(cell => cell.classList.add('conflict'));
                }
            });
        }

        function validateSchedule() {
            const conflicts = [];
            const instructorSchedule = {};
            const roomSchedule = {};

            // Check all years for conflicts
            for (let year = 1; year <= 4; year++) {
                if (!schedule[year]) continue;

                days.forEach(day => {
                    timeSlots.forEach(time => {
                        const course = schedule[year][day][time];
                        if (!course) return;

                        const key = `${day}-${time}`;

                        // Check instructor conflicts
                        if (instructorSchedule[course.instructor]) {
                            if (instructorSchedule[course.instructor][key]) {
                                conflicts.push({
                                    type: 'instructor_overlap',
                                    message: `Instructor ${course.instructor} has overlapping classes`,
                                    day,
                                    time,
                                    courses: [instructorSchedule[course.instructor][key].name, course.name]
                                });
                            }
                        } else {
                            instructorSchedule[course.instructor] = {};
                        }
                        instructorSchedule[course.instructor][key] = course;

                        // Check room capacity
                        if (course.is_lab && course.capacity > 40) {
                            conflicts.push({
                                type: 'capacity_exceeded',
                                message: `Lab capacity exceeded: ${course.name} (${course.capacity} > 40)`,
                                course: course.name
                            });
                        }

                        // Check Friday exam block violation
                        if (day === 'Friday' && (time === '13:00-14:00' || time === '14:00-15:00')) {
                            conflicts.push({
                                type: 'exam_block_violation',
                                message: `Course scheduled during Friday exam block: ${course.name}`,
                                day,
                                time,
                                course: course.name
                            });
                        }
                    });

                    // Check daily instructor hour limits
                    Object.keys(instructorSchedule).forEach(instructor => {
                        const dailyHours = getDailyInstructorHours(instructor, day, instructorSchedule);
                        if (dailyHours > 4) {
                            conflicts.push({
                                type: 'instructor_overload',
                                message: `Instructor ${instructor} exceeds 4 hours on ${day} (${dailyHours} hours)`,
                                instructor,
                                day
                            });
                        }
                    });
                });
            }

            return conflicts;
        }

        function showValidationReport() {
            const conflicts = validateSchedule();
            const reportDiv = document.getElementById('validation-report');
            const contentDiv = document.getElementById('validation-content');

            if (conflicts.length === 0) {
                contentDiv.innerHTML = `
                    <div class="validation-item success">
                        ‚úÖ No conflicts detected! The schedule is valid.
                    </div>
                    <div class="validation-item success">
                        ‚úÖ All instructor availability constraints met
                    </div>
                    <div class="validation-item success">
                        ‚úÖ Friday exam block respected
                    </div>
                    <div class="validation-item success">
                        ‚úÖ Lab capacity limits observed
                    </div>
                `;
            } else {
                const conflictsByType = {};
                conflicts.forEach(conflict => {
                    if (!conflictsByType[conflict.type]) {
                        conflictsByType[conflict.type] = [];
                    }
                    conflictsByType[conflict.type].push(conflict);
                });

                contentDiv.innerHTML = Object.keys(conflictsByType).map(type => {
                    const typeConflicts = conflictsByType[type];
                    const severity = type.includes('violation') || type.includes('overlap') ? 'error' : 'warning';
                    
                    return typeConflicts.map(conflict => `
                        <div class="validation-item ${severity}">
                            ${severity === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${conflict.message}
                        </div>
                    `).join('');
                }).join('');
            }

            reportDiv.style.display = 'block';
            reportDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function clearAllCourses() {
            if (courses.length === 0) {
                showStatus('No courses to clear', 'warning');
                return;
            }

            const btn = document.getElementById('clear-all-btn');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span>Clearing...';
            btn.disabled = true;

            try {
                if (window.dataSdk) {
                    for (const course of courses) {
                        await window.dataSdk.delete(course);
                    }
                }
                
                schedule = {};
                generateTimetableGrid();
                document.getElementById('validation-report').style.display = 'none';
                showStatus('All courses cleared successfully', 'success');
            } catch (error) {
                showStatus('Failed to clear courses', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function updateYearTabs() {
            document.querySelectorAll('.year-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.year) === currentYear);
            });
        }

        function showStatus(message, type = 'info') {
            const statusBar = document.getElementById('status-bar');
            const statusMessage = document.getElementById('status-message');
            
            statusBar.className = `status-bar ${type}`;
            statusMessage.textContent = message;
            statusBar.style.display = 'block';

            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 3000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f12845e66723a1',t:'MTc2MzIzNDk2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
